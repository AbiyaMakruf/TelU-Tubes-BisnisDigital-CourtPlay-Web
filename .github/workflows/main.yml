name: Build, Push, and Deploy Laravel to Cloud Run

on:
  push:
    branches: [main, developement]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§¾ Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ”‘ Ekstrak VITE_PUSHER_APP_KEY untuk Docker Build Arg
      # Langkah ini penting agar kunci Pusher tersedia saat 'npm run build' di Dockerfile
      - name: Extract VITE_PUSHER_APP_KEY for Docker Build
        id: pusher_key
        run: |
          # Buat file sementara dari secret ENV_PRODUCTION_FILE
          echo "${{ secrets.ENV_PRODUCTION_FILE }}" > .env.temp
          # Cari dan bersihkan nilai VITE_PUSHER_APP_KEY
          # (Menggunakan grep, cut, dan tr untuk menghilangkan quotes dan whitespace)
          PUSHER_KEY=$(grep 'VITE_PUSHER_APP_KEY' .env.temp | cut -d '=' -f 2 | tr -d '"\r\n' | tr -d ' ')
          # Simpan sebagai output untuk digunakan di langkah build
          echo "VITE_PUSHER_KEY=${PUSHER_KEY}" >> $GITHUB_OUTPUT
          rm .env.temp
          echo "Pusher Key Extracted Successfully."
          
      # ðŸ› ï¸ Set up Key for Laravel GCS
      - name: Create Laravel GCS Key File from Secret
        run: |
          mkdir -p storage/app/keys
          echo '${{ secrets.GCP_SA_KEY_WEB }}' > storage/app/keys/courtplay-gcs-key.json

      # ðŸ§© Create GCP credentials file
      - name: Create GCP credentials file
        run: |
          # File ini digunakan untuk otentikasi gcloud dan docker login
          echo '${{ secrets.GCP_SA_KEY }}' > $HOME/gcp-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-key.json" >> $GITHUB_ENV

      # â˜ï¸ Setup Google Cloud SDK
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      # --- Konfigurasi Docker Buildx untuk Caching ---
      
      # 1. Setup QEMU (Opsional, tapi disarankan)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. Setup Buildx (Wajib untuk Caching dan build modern)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      # 3. Konfigurasi Docker untuk Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          # Login Docker ke Artifact Registry
          gcloud auth configure-docker asia-southeast1-docker.pkg.dev --quiet

      # Variabel untuk tag image (agar tidak berulang)
      - name: Set image tag
        id: image
        run: echo "TAG=asia-southeast1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/courtplay-repo/courtplay-web:latest" >> $GITHUB_OUTPUT

      # --- 4. Build dan Push dengan Caching ---
      - name: Build and push Docker image with GHA Cache
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.image.outputs.TAG }}
          # SUNTIKKAN BUILD-ARG YANG SUDAH DIEKSTRAK DI SINI:
          build-args: |
            VITE_PUSHER_APP_KEY=${{ steps.pusher_key.outputs.VITE_PUSHER_KEY }}
          # Ambil cache dari GitHub Actions Cache
          cache-from: type=gha
          # Simpan cache ke GitHub Actions Cache (mode=max memastikan semua layer disimpan)
          cache-to: type=gha,mode=max

      # ðŸ” Create .env.production file from GitHub Secret
      # Langkah ini WAJIB dipertahankan, karena isinya akan dilewatkan
      # ke Cloud Run sebagai variabel lingkungan server.
      - name: Create .env.production file
        run: |
          echo "${{ secrets.ENV_PRODUCTION_FILE }}" > .env.production

      # ðŸš€ Deploy to Cloud Run (CPU)
      - name: Deploy to Cloud Run (CPU)
        run: |
          # Convert .env.production (KEY=VALUE) â†’ gcloud format KEY=VALUE,KEY2=VALUE2
          # Pastikan semua kunci yang dibutuhkan (termasuk PUSHER_APP_SECRET, dll.)
          # ada di ENV_PRODUCTION_FILE dan diparse dengan benar.
          ENV_VARS=$(grep -v '^#' .env.production | grep '=' | sed '/^$/d' | tr '\n' ',' | sed 's/,$//')
          gcloud run deploy courtplay-web \
            --image=${{ steps.image.outputs.TAG }} \
            --region=asia-southeast1 \
            --platform=managed \
            --service-account=github-runner-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --port=8080 \
            --cpu=2 \
            --memory=2Gi \
            --use-http2 \
            --async \
            --cpu-boost \
            --set-env-vars="$ENV_VARS"

      # ðŸš¦ Update Lalu Lintas ke Revisi Terbaru
      - name: Route Traffic to Latest Revision
        run: |
          gcloud run services update-traffic courtplay-web \
            --to-latest \
            --region=asia-southeast1